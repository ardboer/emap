# Icon Generation Implementation Plan

## Executive Summary

This document outlines the plan to replace the current custom `assetGenerator.js` with a solution that leverages Expo's built-in icon generation utilities to properly support:

- ✅ Android adaptive icons with separate foreground/background layers
- ✅ iOS dark mode icons (iOS 18+)
- ✅ All required icon densities and formats
- ✅ Multi-brand workflow integration

## Research Findings

### Current State Analysis

**Current `assetGenerator.js` Limitations:**

- ❌ Does NOT generate Android adaptive icon background layers
- ❌ Does NOT generate Android adaptive icon XML configuration files
- ❌ Does NOT support iOS dark mode icon variants
- ❌ Does NOT support iOS tinted icons
- ✅ Generates iOS app icons (all sizes)
- ✅ Generates Android mipmap foreground layers only
- ✅ Generates splash screen assets
- ✅ Supports brand-specific background colors

### Third-Party Package Evaluation

**app-icon Package:**

- ❌ Last updated 6 years ago (v0.13.2)
- ❌ Adaptive icons in ALPHA state (requires `--adaptive-icons` flag)
- ❌ No dark mode support
- ❌ May not support latest iOS/Android requirements
- ✅ Supports SVG input
- ✅ Generates standard icons

**Verdict:** Not suitable for production use

### Expo's Built-in Solution

**@expo/image-utils + @expo/prebuild-config:**

- ✅ Already installed as dependencies
- ✅ Actively maintained by Expo team
- ✅ Full adaptive icon support with foreground/background layers
- ✅ iOS 18 dark mode icon support
- ✅ iOS 18 tinted icon support
- ✅ Handles all icon densities automatically
- ✅ Can be used WITHOUT running full `expo prebuild`

**Key Discovery:** Expo's icon generation can be extracted and used standalone!

## Technical Architecture

### Expo's Icon Generation Functions

Located in `@expo/prebuild-config` and `@expo/image-utils`:

```javascript
// From @expo/image-utils
generateImageAsync(options, imageOptions);
// Generates a single image with caching support

// From @expo/prebuild-config/build/plugins/icons/withAndroidIcons.js
generateIconAsync(projectRoot, {
  cacheType,
  src,
  scale,
  backgroundColor,
  isAdaptive,
});
// Generates Android icons at specific densities

// From @expo/prebuild-config/build/plugins/icons/withIosIcons.js
generateUniversalIconAsync(projectRoot, {
  icon,
  cacheKey,
  iosNamedProjectRoot,
  platform,
  appearance,
});
// Generates iOS icons with dark mode support
```

### Android Adaptive Icon Requirements

**Files that MUST be generated:**

1. **Foreground layers** (already generated by current script):

   ```
   android/app/src/main/res/
   ├── mipmap-mdpi/ic_launcher_foreground.webp
   ├── mipmap-hdpi/ic_launcher_foreground.webp
   ├── mipmap-xhdpi/ic_launcher_foreground.webp
   ├── mipmap-xxhdpi/ic_launcher_foreground.webp
   └── mipmap-xxxhdpi/ic_launcher_foreground.webp
   ```

2. **Background layers** (MISSING - needs to be added):

   ```
   android/app/src/main/res/
   ├── mipmap-mdpi/ic_launcher_background.webp
   ├── mipmap-hdpi/ic_launcher_background.webp
   ├── mipmap-xhdpi/ic_launcher_background.webp
   ├── mipmap-xxhdpi/ic_launcher_background.webp
   └── mipmap-xxxhdpi/ic_launcher_background.webp
   ```

3. **Adaptive icon XML configuration** (MISSING - needs to be added):

   ```
   android/app/src/main/res/mipmap-anydpi-v26/
   ├── ic_launcher.xml
   └── ic_launcher_round.xml
   ```

4. **Background color in colors.xml** (optional, alternative to background images):
   ```xml
   <color name="iconBackground">#FFFFFF</color>
   ```

### iOS Dark Mode Icon Requirements

**iOS 18 Icon Structure:**

```
ios/emap/Images.xcassets/AppIcon.appiconset/
├── App-Icon-1024x1024@1x.png          # Light mode
├── App-Icon-dark-1024x1024@1x.png     # Dark mode
├── App-Icon-180x180@1x.png            # Light mode
├── App-Icon-dark-180x180@1x.png       # Dark mode
└── Contents.json                       # Updated with appearance metadata
```

**Contents.json Structure:**

```json
{
  "images": [
    {
      "filename": "App-Icon-1024x1024@1x.png",
      "idiom": "universal",
      "platform": "ios",
      "size": "1024x1024"
    },
    {
      "appearances": [
        {
          "appearance": "luminosity",
          "value": "dark"
        }
      ],
      "filename": "App-Icon-dark-1024x1024@1x.png",
      "idiom": "universal",
      "platform": "ios",
      "size": "1024x1024"
    }
  ]
}
```

## Implementation Plan

### Phase 1: Create New Icon Generator Script

**File:** `scripts/iconGenerator.js`

**Responsibilities:**

1. Import and use Expo's `generateImageAsync` function
2. Generate iOS app icons (light, dark, tinted variants)
3. Generate Android adaptive icons (foreground + background layers)
4. Generate Android adaptive icon XML configuration
5. Update iOS Contents.json with appearance metadata
6. Support brand-specific configurations (colors, padding)
7. Maintain compatibility with existing multi-brand workflow

**Key Features:**

- Use `@expo/image-utils` for image generation
- Leverage Expo's caching system (`.expo` directory)
- Support SVG input from `brands/{brand}/logo.svg`
- Generate all required densities automatically
- Create proper XML configuration files

### Phase 2: Integration with Prebuild Workflow

**Modify:** `scripts/prebuild.js`

**Changes:**

1. Import new `iconGenerator.js` instead of `assetGenerator.js`
2. Call icon generation with brand configuration
3. Maintain fallback to legacy generator if needed
4. Keep existing asset copying logic for other files

**Integration Point (line 424-459 in prebuild.js):**

```javascript
// Replace this section:
const generateBrandAssets = async () => {
  const assetGenerator = new AssetGenerator(projectRoot);
  // ... existing code
};

// With:
const generateBrandAssets = async () => {
  const iconGenerator = new IconGenerator(projectRoot);
  await iconGenerator.generateAllIcons(brand, brandConfig);
};
```

### Phase 3: Legacy Support

**Action:** Rename `scripts/assetGenerator.js` to `scripts/assetGenerator.legacy.js`

**Purpose:**

- Keep as reference implementation
- Fallback option if new generator has issues
- Historical documentation of custom approach

### Phase 4: Testing & Validation

**Test Matrix:**

| Brand | iOS Light | iOS Dark | Android Adaptive | Splash Screens |
| ----- | --------- | -------- | ---------------- | -------------- |
| cn    | ✓         | ✓        | ✓                | ✓              |
| nt    | ✓         | ✓        | ✓                | ✓              |
| jnl   | ✓         | ✓        | ✓                | ✓              |

**Validation Steps:**

1. Generate icons for one brand (cn)
2. Verify all iOS icon sizes are created
3. Verify iOS dark mode icons exist
4. Verify Android foreground layers exist
5. Verify Android background layers exist
6. Verify Android XML configuration files exist
7. Build and test on physical devices
8. Verify icons display correctly in light/dark modes
9. Verify adaptive icon animations work on Android

## Implementation Details

### Icon Generator Class Structure

```javascript
class IconGenerator {
  constructor(projectRoot) {
    this.projectRoot = projectRoot;
  }

  async generateAllIcons(brand, brandConfig) {
    // 1. Generate iOS icons (light, dark, tinted)
    await this.generateIOSIcons(brand, brandConfig);

    // 2. Generate Android adaptive icons
    await this.generateAndroidAdaptiveIcons(brand, brandConfig);

    // 3. Generate splash screens (keep existing logic)
    await this.generateSplashScreens(brand, brandConfig);

    // 4. Copy to brand assets directory
    await this.copyToBrandAssets(brand);
  }

  async generateIOSIcons(brand, brandConfig) {
    // Use Expo's generateUniversalIconAsync
    // Generate light, dark, and tinted variants
  }

  async generateAndroidAdaptiveIcons(brand, brandConfig) {
    // Generate foreground layers
    // Generate background layers
    // Create XML configuration files
    // Update colors.xml if needed
  }
}
```

### Android Adaptive Icon XML Template

```xml
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@mipmap/ic_launcher_background"/>
    <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
</adaptive-icon>
```

### Brand Configuration Support

**Existing brand config properties to use:**

```json
{
  "branding": {
    "logo": "./logo.svg",
    "iconBackgroundColor": "#ffffff"
  }
}
```

**New optional properties to consider:**

```json
{
  "branding": {
    "logo": "./logo.svg",
    "iconBackgroundColor": "#ffffff",
    "darkModeIcon": "./logo-dark.svg", // Optional: separate dark mode logo
    "tintedIcon": "./logo-tinted.svg", // Optional: separate tinted logo
    "adaptiveIconPadding": 25 // Optional: custom padding for adaptive icons
  }
}
```

## Benefits of This Approach

1. **Production-Ready:** Uses Expo's battle-tested icon generation
2. **Future-Proof:** Automatically gets updates from Expo team
3. **Complete Support:** Handles all icon types and variants
4. **No Expo Prebuild:** Can use icon generation without full prebuild
5. **Maintains Workflow:** Integrates seamlessly with existing multi-brand system
6. **Proper Standards:** Generates icons according to Apple/Google guidelines
7. **Dark Mode Ready:** Full iOS 18 dark mode support
8. **Adaptive Icons:** Proper Android adaptive icons with all layers

## Migration Path

### Step 1: Install Dependencies (if needed)

```bash
# @expo/image-utils and @expo/prebuild-config are already installed
# Verify they're in package.json
```

### Step 2: Create New Icon Generator

```bash
# Create scripts/iconGenerator.js
# Implement using Expo's utilities
```

### Step 3: Update Prebuild Script

```bash
# Modify scripts/prebuild.js
# Replace assetGenerator with iconGenerator
```

### Step 4: Preserve Legacy

```bash
# Rename scripts/assetGenerator.js to scripts/assetGenerator.legacy.js
```

### Step 5: Test

```bash
# Test with one brand
node scripts/prebuild.js cn

# Verify generated icons
# Build and test on devices
```

### Step 6: Document

```bash
# Update docs/svg-asset-generation-guide.md
# Add new capabilities to documentation
```

## Rollback Plan

If issues arise:

1. Revert `prebuild.js` to use `assetGenerator.legacy.js`
2. Investigate and fix issues in `iconGenerator.js`
3. Re-test and deploy

## Timeline Estimate

- **Phase 1 (Icon Generator):** 4-6 hours
- **Phase 2 (Integration):** 2-3 hours
- **Phase 3 (Legacy Support):** 1 hour
- **Phase 4 (Testing):** 3-4 hours
- **Documentation:** 2 hours

**Total:** 12-16 hours

## Success Criteria

- [ ] All iOS icon sizes generated correctly
- [ ] iOS dark mode icons generated and working
- [ ] Android adaptive icon foreground layers generated
- [ ] Android adaptive icon background layers generated
- [ ] Android adaptive icon XML configuration created
- [ ] Icons display correctly in light mode
- [ ] Icons display correctly in dark mode
- [ ] Adaptive icons animate correctly on Android
- [ ] Multi-brand workflow still functions
- [ ] Build process completes successfully
- [ ] Documentation updated

## References

- [Expo Icon Documentation](https://docs.expo.dev/develop/user-interface/app-icons/)
- [Android Adaptive Icons Guide](https://developer.android.com/develop/ui/views/launch/icon_design_adaptive)
- [iOS App Icon Guidelines](https://developer.apple.com/design/human-interface-guidelines/app-icons)
- [iOS 18 Dark Mode Icons](https://developer.apple.com/documentation/xcode/configuring-your-app-icon)

## Next Steps

1. Review and approve this implementation plan
2. Create `scripts/iconGenerator.js` with Expo utilities
3. Test with Nursing Times (nt) brand
4. Verify all icon types are generated correctly
5. Roll out to all brands
6. Update documentation
